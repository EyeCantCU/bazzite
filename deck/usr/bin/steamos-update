#!/bin/bash

# Check if upgrade has already been installed
if [ -f '/tmp/upgrade-installed' ]; then
  exit 7 # Upgrade installed
fi

function upgrade() {
  rpm-ostree upgrade --unchanged-exit-77
  echo $? > /tmp/upgrade-check
}
UPGRADE=$(upgrade | grep -o '[^ ]*%')
UPGRADE_CHECK=$(cat /tmp/upgrade-check)
rm /tmp/upgrade-check

if grep "No upgrade available." <<< ${UPGRADE}; then
  exit 7 # No upgrade available
fi

# Check if rpm-ostree failed to update
if [ ${UPGRADE_CHECK} -eq 77 ]; then
  exit 0
fi

# Check if user has gone through initial setup
if [ -f '~/.local/share/Steam/config/loginusers.vdf' ]; then
  touch /tmp/upgrade-installed
  exit 7 # Upgrade installed
else
  exit 0 # Upgrade available
fi
